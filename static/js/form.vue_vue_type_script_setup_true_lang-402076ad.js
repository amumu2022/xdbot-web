import{$ as B,k as s,p as re,t as ue,aI as x,S as a,aJ as V,ag as z,e as n,r as p,aH as Y,R as ce,N as ie,d as de,o as I,i as L,j as m,f as S,c as me,F as pe,v as fe}from"./index-9cea40a6.js";import{R as P}from"./index-17695056.js";import{s as ge}from"./corn-44f32457.js";import ve from"./fileDetial-5eda83e3.js";import{R as j,S as A,l as he,U as be,d as ye,m as _e,g as ke,c as Se,a as Re}from"./log-82ff53a2.js";import{g as E,a as xe}from"./dock-9ddcdacf.js";import{u as Ce}from"./hooks-a6049d28.js";import{E as Te,p as $e}from"./xdteam-5bf4004a.js";import{u as De}from"./useBasicLayout-7ee1042a.js";const{isMobile:q}=De();function N(u){const i=B({name:"",enable:void 0,status:void 0,currentPage:1,pageSize:10}),v=s(),g=s([]),l=s(!0),h=s(0),f=s({}),R=s([]),{switchStyle:H}=Ce(),d=B({total:0,pageSize:10,currentPage:1,pageSizes:[5,10,20,50,100],background:!0}),b=s(""),y=s(b.value),C=re(()=>["!h-[20px]","reset-margin","!text-gray-500","dark:!text-white","dark:hover:!text-primary"]),T=e=>(i.currentPage-1)*i.pageSize+e+1,$=()=>{Te(g,U)},D=()=>{const e=u.value.getTableRef().getSelectionRows();j(x(e,"id")).then(async t=>{t.code===200?a("正在批量运行任务",{type:"success"}):a(`操作失败，${t.message}`,{type:"error"}),u.value.getTableRef().clearSelection()})},c=()=>{const e=u.value.getTableRef().getSelectionRows();A(x(e,"id")).then(async t=>{t.code===200?a("已批量停止任务",{type:"success"}):a(`操作失败，${t.message}`,{type:"error"}),u.value.getTableRef().clearSelection()})},F=e=>{j([e]).then(async t=>{t.code===200?(a(t.message,{type:"success"}),o()):a(`操作失败，${t.message}`,{type:"error"})})},J=e=>{A([e]).then(async t=>{t.code===200?(a(t.message,{type:"success"}),o()):a(`操作失败，${t.message}`,{type:"error"})})},G=e=>{V({title:"日志详情",width:"46%",draggable:!0,fullscreenIcon:!0,fullscreen:!!q.value,contentRenderer:()=>z(he,{id:e,"onUpdate:data":t=>b.value=t}),closeCallBack:()=>{b.value=y.value,o()}})},U=[{label:"列表",type:"selection"},{label:"序号",type:"index",index:T,minWidth:50,sortable:!0},{label:"任务名称",prop:"name",minWidth:100,sortable:!0},{label:"任务文件",prop:"work_file",minWidth:120,cellRenderer:({row:e})=>{const t=()=>{W("查看",e)};return(()=>n(p("el-button"),{type:"primary",onClick:t,link:!0},{default:()=>[e==null?void 0:e.work_file]}))()}},{label:"运行状态",prop:"status",minWidth:80,sortable:!0,cellRenderer:({row:e,props:t})=>n(p("el-tag"),{size:t.size,type:e.status===0?"danger":"success"},{default:()=>[e.status===0?"空闲中":"运行中"]})},{label:"状态",prop:"enable",minWidth:90,cellRenderer:e=>{var t;return n(p("el-switch"),{size:e.props.size==="small"?"small":"default",loading:(t=f.value[e.index])==null?void 0:t.loading,modelValue:e.row.enable,"onUpdate:modelValue":r=>e.row.enable=r,"active-value":!0,"inactive-value":!1,"active-text":"已激活","inactive-text":"已停用","inline-prompt":!0,style:H.value,onChange:()=>K(e)},null)}},{label:"corn表达式",minWidth:100,prop:"schedule"},{label:"运行时长",minWidth:80,sortable:!0,prop:"last_run_time"},{label:"最后运行时间",minWidth:120,sortable:!0,prop:"last_execution_time",formatter:({last_execution_time:e})=>Y(e*1e3).format("YYYY-MM-DD HH:mm:ss")},{label:"下次运行时间",minWidth:120,sortable:!0,prop:"corn",formatter:({schedule:e})=>Y($e(e)[0]).format("YYYY-MM-DD HH:mm:ss")},{label:"操作",fixed:"right",width:150,slot:"operation"}];function K({row:e,index:t}){ce.confirm(`确认要<strong>${e.enable===!1?"停用":"启用"}</strong><strong style='color:var(--el-color-primary)'>${e.name}</strong>任务吗?`,"系统提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0,draggable:!0}).then(()=>{f.value[t]=Object.assign({},f.value[t],{loading:!0}),be(e.id).then(r=>{r.code===200?setTimeout(()=>{f.value[t]=Object.assign({},f.value[t],{loading:!1}),a("已成功修改任务状态",{type:"success"})},200):a(`操作失败，${r.message}`,{type:"error"})})}).catch(()=>{e.enable===0?e.enable=1:e.enable=0})}function Q(e){ye(e.id).then(async t=>{t.code===200?(a(`您删除了任务编号为${e.id}的这条数据`,{type:"success"}),await o()):a(`操作失败，${t.message}`,{type:"error"})})}function X(e){h.value=e.length,u.value.setAdaptive()}function Z(){h.value=0,u.value.getTableRef().clearSelection()}function w(){const e=u.value.getTableRef().getSelectionRows();_e(x(e,"id")).then(async t=>{t.code===200?(a(`已删除任务ID为 ${x(e,"id")} 的数据`,{type:"success"}),await o()):a(`操作失败，${t.message}`,{type:"error"}),u.value.getTableRef().clearSelection()})}function ee(e){i.currentPage=1,i.pageSize=e,o()}function te(e){i.currentPage=e,o()}async function o(){l.value=!0;const{data:e}=await ke(ie(i));g.value=e.results,d.total=e.total,setTimeout(()=>{l.value=!1},500)}async function ae(){l.value=!0;const{data:e}=await xe({name:""}),t=e.results;R.value=t.map(r=>({value:r.name,label:r.name})),setTimeout(()=>{l.value=!1},500)}const le=e=>{e&&(e.resetFields(),o())};function W(e="新增",t){const r=s();if(e=="查看"){E(t==null?void 0:t.work_file).then(async _=>{if(_.code!==200)return a(`操作失败，${_.message}`,{type:"error"}),"";r.value=_.data,V({title:`${e}脚本`,props:{title:e,name:(t==null?void 0:t.name)??"",content:r.value},draggable:!0,fullscreen:!0,closeOnClickModal:!1,contentRenderer:()=>z(ve,{ref:v})})});return}V({title:`${e}任务`,props:{formInline:{title:e,name:(t==null?void 0:t.name)??"",work_file:(t==null?void 0:t.work_file)??"",enable:(t==null?void 0:t.enable)??!0,schedule:(t==null?void 0:t.schedule)??""}},width:"46%",draggable:!0,fullscreenIcon:!0,fullscreen:!!q.value,closeOnClickModal:!1,contentRenderer:()=>z(Me,{ref:v}),beforeSure:(_,{options:ne})=>{const se=v.value.getRef(),M=ne.props.formInline;function O(){a(`您${e}了任务为${M.name}的这条数据`,{type:"success"}),_(),o()}se.validate(oe=>{oe&&(e==="新增"?Se(M).then(async k=>{k.code===200?await O():a(`操作失败，${k.message}`,{type:"error"})}):e==="编辑"&&Re(t.id,M).then(async k=>{k.code===200?await O():a(`操作失败，${k.message}`,{type:"error"})}))})}})}return ue(()=>{o(),ae()}),{form:i,loading:l,columns:U,dataList:g,selectedNum:h,pagination:d,fileOptions:R,buttonClass:C,onbatchDel:w,getScript:E,manyHandleRun:D,handleLog:G,manyHandleStop:c,handleRun:F,handleStop:J,onSearch:o,resetForm:le,openDialog:W,exportExcel:$,handleDelete:Q,onSelectionCancel:Z,handleSizeChange:ee,handleCurrentChange:te,handleSelectionChange:X}}const Ye=Object.freeze(Object.defineProperty({__proto__:null,useRole:N},Symbol.toStringTag,{value:"Module"})),Fe=B({name:[{required:!0,message:"任务名称为必填项",trigger:"blur"}],work_file:[{required:!0,message:"任务文件为必填项",trigger:"blur"}],schedule:[{required:!0,message:"cron表达式为必填项",trigger:"blur"}]}),Me=de({__name:"form",props:{formInline:{default:()=>({title:"新增",name:"",work_file:"",schedule:""})}},setup(u,{expose:i}){const v=u,g=s(),l=s(v.formInline);function h(){return g.value}const f=s(),{fileOptions:R}=N(f);return i({getRef:h}),(H,d)=>{const b=p("el-input"),y=p("el-form-item"),C=p("el-option"),T=p("el-select"),$=p("el-row"),D=p("el-form");return I(),L(D,{ref_key:"ruleFormRef",ref:g,model:l.value,rules:S(Fe),"label-width":"82px"},{default:m(()=>[n($,{gutter:30},{default:m(()=>[n(S(P),{value:24,xs:24,sm:24},{default:m(()=>[n(y,{label:"任务名称",prop:"name"},{default:m(()=>[n(b,{modelValue:l.value.name,"onUpdate:modelValue":d[0]||(d[0]=c=>l.value.name=c),clearable:"",placeholder:"请输入任务名称"},null,8,["modelValue"])]),_:1})]),_:1}),n(S(P),{value:24,xs:24,sm:24},{default:m(()=>[n(y,{label:"任务文件",prop:"work_file"},{default:m(()=>[n(T,{modelValue:l.value.work_file,"onUpdate:modelValue":d[1]||(d[1]=c=>l.value.work_file=c),placeholder:"请选择任务文件",class:"w-full",clearable:""},{default:m(()=>[(I(!0),me(pe,null,fe(S(R),(c,F)=>(I(),L(C,{key:F,label:c.label,value:c.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),n(S(P),{value:24,xs:24,sm:24},{default:m(()=>[n(y,{label:"cron",prop:"schedule"},{default:m(()=>[n(ge,{modelValue:l.value.schedule,"onUpdate:modelValue":d[2]||(d[2]=c=>l.value.schedule=c),placeholder:"请输入Cron定时规则",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","rules"])}}});export{Me as _,Ye as h,N as u};
