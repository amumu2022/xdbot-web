import H from"./form-a410b04b.js";import{aN as i,$ as O,k as d,t as _,N as R,R as h,S as a,aO as J,aJ as N,ag as E}from"./index-9cea40a6.js";import{r as G}from"./monitor-142346d2.js";import{g as $}from"./xdteam-5bf4004a.js";import{u as Q}from"./useBasicLayout-7ee1042a.js";/* empty css              */import"./codeEditor-08c5f378.js";import"./formPrimitive.vue_vue_type_script_setup_true_lang-c7783394.js";import"./index-17695056.js";const j=()=>i.request("get","/api/plugins/online/list"),K=n=>i.request("post","/api/plugins/list",{data:n}),q=n=>i.request("post","/api/plugins/add",{data:n}),V=n=>i.request("delete","/api/plugins/del",{data:n}),W=n=>i.request("post","/api/plugins/update",{data:n}),X=n=>i.request("put","/api/plugins/status",{data:n}),Y=n=>i.request("get",`/api/plugins/get/code/${n}`),Z=n=>i.request("post","/api/plugins/update/code",{data:n}),w=n=>i.request("post","/api/plugins/add/local",{data:n});function oe(){const n=O({name:"",installed:"1",enable:void 0}),v=d(!0),C=d(),b=d(!1),u=d([]),r=d({current:1,pageSize:12,total:0}),{isMobile:m}=Q();function S(e,t){const c=new Map(e.map(s=>[s.name,s]));return t.map(s=>{const o=c.get(s.name);return o?{...o,...s}:s})}async function l(){try{const e=R(n),t=e.name;e.enable==""&&(e.enable=void 0);const o=(await K(R(n))).data.results,p=e.installed,{data:f}=await j();u.value=f.results.filter(y=>y.name.includes(t)),p==="1"&&(u.value=S(u.value,o)),r.value={...r.value,total:u.value.length}}catch{}finally{setTimeout(()=>{},500)}}const k=e=>{r.value.pageSize=e,r.value.current=1},T=e=>{r.value.current=e},A=e=>{h.alert(e!=null&&e.desc?e==null?void 0:e.desc:"作者好懒...还没写简介呢",e.name,{confirmButtonText:"好的"})},B=e=>{W(e).then(async t=>{t.code===200?(l(),a(`插件 ${e.name} 更新成功，需要手动重启系统重载插件`,{type:"success"})):a(`操作失败，${t.message}`,{type:"error"})})},D=e=>{const t=e.enable;X(e).then(async c=>{c.code===200?(l(),a(`插件 ${e.name} ${t?"已停用":"已启用"}`,{type:"success"})):a(`操作失败，${c.message}`,{type:"error"})})},L=e=>{a(`插件 ${e.name} 举报失败`,{type:"error"})},M=e=>{V(e).then(async t=>{t.code===200?(l(),a(`插件 ${e.name} 卸载成功，需要手动重启系统重载插件`,{type:"warning"})):a(`操作失败，${t.message}`,{type:"error"})})},x=e=>{J(e.url,`${e.name}.py`)},I=async e=>{try{const t=await q(e);if(t.code===200)l(),a(`插件 ${e.name} 安装成功，需要手动重启系统重载插件`,{type:"success"});else if(t.code===201){if(await h.confirm("已存在该插件，是否<strong><span style='color:red'>强制安装/更新</span></strong>","系统提示",{confirmButtonText:"立即安装",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0,draggable:!0})==="confirm"){const s=await q({...e,enforce:!0});s.code===200?(l(),a(`插件 ${e.name} 强制安装成功，需要手动重启系统重载插件`,{type:"success"})):a(`强制安装失败，${s.message}`,{type:"error"})}}else a(`操作失败，${t.message}`,{type:"error"})}catch{a("安装失败，请稍后再试",{type:"error"})}};function U(){h.confirm("请确定是否<strong><span style='color:red'>立即重启系统</span></strong>","系统提示",{confirmButtonText:"立即重启",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0,draggable:!0}).then(()=>{a("系统重启中",{type:"warning"}),G()})}async function F(e){if(e.enable){const{data:t}=await Y(e.folder);e.code=t,P("编辑",e)}else a("只有已启用的插件才可编辑",{type:"error"})}const z=e=>{e&&(e.resetFields(),l())};_(async()=>{l(),b.value=!m.value,v.value=!1});function P(e="新增",t){N({title:`${e}插件`,props:{formInline:{title:e,name:(t==null?void 0:t.name)??"",code:(t==null?void 0:t.code)??"",version:(t==null?void 0:t.version)??"1.0.0",author:(t==null?void 0:t.author)??"",type:(t==null?void 0:t.type)??"日常",folder:(t==null?void 0:t.folder)??`${$(1,1)}${$(2,2)}_${$(2,4)}`,image:(t==null?void 0:t.image)??"https://ts3.cn.mm.bing.net/th?id=OIP-C.JA4-FcgT71zBprqSv3c4AQHaHa&w=250&h=250&c=8&rs=1&qlt=90&o=6&dpr=1.5&pid=3.1&rm=2",url:(t==null?void 0:t.url)??"",path:(t==null?void 0:t.path)??"string",score:(t==null?void 0:t.score)??3,downloads:(t==null?void 0:t.downloads)??1e3}},draggable:!0,fullscreenIcon:!0,width:"70%",fullscreen:!!m.value,closeOnClickModal:!1,contentRenderer:()=>E(H,{ref:C}),beforeSure:(c,{options:s})=>{const o=C.value.getRef(),p=s.props.formInline;function f(){a(`您${e}了插件名为${p.name}的这条数据，需要手动重启系统重载插件`,{type:"success"}),c(),l()}o.validate(y=>{y&&(e==="新增"?w(p).then(async g=>{g.code===200?await f():a(`操作失败，${g.message}`,{type:"error"})}):e==="编辑"&&Z(p).then(async g=>{g.code===200?await f():a(`操作失败，${g.message}`,{type:"error"})}))})}})}return{onPageSizeChange:k,funcRestart:U,onSearch:l,searchStatus:b,productList:u,pagination:r,isMobile:m,form:n,loading:v,resetForm:z,openDialog:P,onCurrentChange:T,handleClickDetial:A,handleClickUpdate:B,handleClickStop:D,handleClickReport:L,handleClickDelete:M,handleClickDownloads:x,handleClickInstall:I,handleClickEdit:F}}export{oe as useRole};
