import{aS as T,Y as O,k as i,t as se,ar as H,e as s,r as v,aN as oe,ay as m,aH as B,M as re,aI as L,ae as W,d as ue,o as h,i as R,j as r,f as g,c as A,F as N,v as G,B as J}from"./index-6f723797.js";import{R as $}from"./index-80faaafb.js";import{s as de}from"./corn-83152c75.js";import ce from"./fileDetial-7826ecf9.js";import{g as K,a as ie}from"./dock-ec7e72b8.js";import{u as me}from"./hooks-2dd4676b.js";import{E as pe}from"./xdteam-1bd5232c.js";import{u as fe}from"./useBasicLayout-67c5ef4f.js";const ge=n=>T.request("post","/api/v1/task/list",{data:n}),ve=n=>T.request("post","/api/v1/task/add",{data:n}),_e=(n,o)=>{const _=`/api/v1/task/del/${n}/${o}`;return T.request("delete",_)},be=(n,o)=>T.request("delete",`/api/v1/task/${n}/batch_remove`,{data:o}),ke=(n,o)=>{const _=`/api/v1/task/${n}/${o}/status`;return T.request("put",_)},{isMobile:he}=fe();function Q(n){const o=O({id_code:5,enable:"",work_timestamp:void 0,currentPage:1,pageSize:10}),_=[{value:5,label:"脚本任务"}],y=i(),t=i([]),b=i(!0),x=i(0),k=i({}),D=i([]),{switchStyle:z}=me(),u=O({total:0,pageSize:10,currentPage:1,pageSizes:[5,10,20,50,100],background:!0}),E=e=>(o.currentPage-1)*o.pageSize+e+1,M=()=>{pe(t,p)},p=[{label:"列表",type:"selection"},{label:"序号",type:"index",index:E,minWidth:50},{label:"任务类型",hide:!0,prop:"id_code"},{label:"任务ID",prop:"task_code",sortable:!0,minWidth:100},{label:"任务名称",prop:"name",minWidth:100},{label:"任务文件",prop:"work_file",minWidth:180,cellRenderer:({row:e})=>{const a=()=>{Y("查看",e)};return(()=>s(v("el-button"),{type:"primary",onClick:a,link:!0},{default:()=>{var S;return[(S=e==null?void 0:e.data)==null?void 0:S.taskCommand]}}))()}},{label:"corn表达式",minWidth:180,prop:"corn",cellRenderer:({row:e})=>{var a;return e.id_code==5?(a=e==null?void 0:e.data)==null?void 0:a.cronExpression:e.id_code==3||e.id_code==4||e.id_code==5?H(e.next_timestamp*1e3).format("YYYY-MM-DD HH:mm:ss"):"-*-"}},{label:"状态",prop:"enable",minWidth:90,cellRenderer:e=>{var a;return s(v("el-switch"),{size:e.props.size==="small"?"small":"default",loading:(a=k.value[e.index])==null?void 0:a.loading,modelValue:e.row.enable,"onUpdate:modelValue":d=>e.row.enable=d,"active-value":!0,"inactive-value":!1,"active-text":"已激活","inactive-text":"已停用","inline-prompt":!0,style:z.value,onChange:()=>F(e)},null)}},{label:"操作",fixed:"right",width:110,slot:"operation"}];function F({row:e,index:a}){oe.confirm(`确认要<strong>${e.enable===!1?"停用":"启用"}</strong><strong style='color:var(--el-color-primary)'>${e.name}</strong>任务吗?`,"系统提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0,draggable:!0}).then(()=>{k.value[a]=Object.assign({},k.value[a],{loading:!0}),ke(e.id_code,e.task_code).then(d=>{d.code===200?setTimeout(()=>{k.value[a]=Object.assign({},k.value[a],{loading:!1}),m("已成功修改任务状态",{type:"success"})},200):m(`操作失败，${d.message}`,{type:"error"})})}).catch(()=>{e.enable===0?e.enable=1:e.enable=0})}function I(e){_e(e.id_code,e.task_code).then(async a=>{a.code===200?(m(`您删除了任务编号为${e.id_code}的这条数据`,{type:"success"}),await f()):m(`操作失败，${a.message}`,{type:"error"})})}function q(e){x.value=e.length,n.value.setAdaptive()}function l(){x.value=0,n.value.getTableRef().clearSelection()}function C(){const e=n.value.getTableRef().getSelectionRows();be(B(e,"id_code")[0],B(e,"task_code")).then(async a=>{a.code===200?(m(`已删除任务编号为 ${B(e,"task_code")} 的数据`,{type:"success"}),await f()):m(`操作失败，${a.message}`,{type:"error"}),n.value.getTableRef().clearSelection()})}function X(e){o.currentPage=1,o.pageSize=e,f()}function Z(e){o.currentPage=e,f()}async function f(){b.value=!0;const{data:e}=await ge(re(o));t.value=e.results,u.total=e.total,setTimeout(()=>{b.value=!1},500)}async function w(){b.value=!0;const{data:e}=await ie({name:""}),a=e.results;D.value=a.map(d=>({value:d.name,label:d.name})),setTimeout(()=>{b.value=!1},500)}const ee=e=>{e&&(e.resetFields(),f())};function Y(e="新增",a){var S,U,P;const d=i();if(e=="查看"){K((S=a==null?void 0:a.data)==null?void 0:S.taskCommand).then(async V=>{if(V.code!==200)return m(`操作失败，${V.message}`,{type:"error"}),"";d.value=V.data,L({title:`${e}脚本`,props:{title:e,name:(a==null?void 0:a.name)??"",content:d.value},draggable:!0,fullscreen:!0,closeOnClickModal:!1,contentRenderer:()=>W(ce,{ref:y})})});return}L({title:`${e}任务`,props:{formInline:{title:e,id_code:(a==null?void 0:a.id_code)??5,task_code:(a==null?void 0:a.task_code)??void 0,name:(a==null?void 0:a.name)??"",interval:(a==null?void 0:a.interval)??"",enable:(a==null?void 0:a.enable)??!1,cronExpression:((U=a==null?void 0:a.data)==null?void 0:U.cronExpression)??"",taskCommand:((P=a==null?void 0:a.data)==null?void 0:P.taskCommand)??"",data:(a==null?void 0:a.data)??[]}},width:"46%",draggable:!0,fullscreenIcon:!0,fullscreen:!!he.value,closeOnClickModal:!1,contentRenderer:()=>W(xe,{ref:y}),beforeSure:(V,{options:ae})=>{const te=y.value.getRef(),c=ae.props.formInline;function le(){m(`您${e}了任务为${c.name}的这条数据`,{type:"success"}),V(),f()}te.validate(ne=>{ne&&((c.id_code==1||c.id_code==2)&&(c.interval=H(c.interval).format("YYYY年M月D日H时m分s秒")),c.id_code==5&&(c.data={taskCommand:c.taskCommand,cronExpression:c.cronExpression}),ve(c).then(async j=>{j.code===200?await le():m(`操作失败，${j.message}`,{type:"error"})}))})}})}return se(()=>{f(),w()}),{form:o,loading:b,columns:p,dataList:t,selectedNum:x,pagination:u,taskTypeOptions:_,fileOptions:D,onbatchDel:C,getScript:K,onSearch:f,resetForm:ee,openDialog:Y,exportExcel:M,handleDelete:I,onSelectionCancel:l,handleSizeChange:X,handleCurrentChange:Z,handleSelectionChange:q}}const Me=Object.freeze(Object.defineProperty({__proto__:null,useRole:Q},Symbol.toStringTag,{value:"Module"})),ye=O({id_code:[{required:!0,message:"任务选项为必填项",trigger:"blur"}],task_code:[{required:!0,message:"任务ID为必填项",trigger:"blur"}],name:[{required:!0,message:"群聊号码为必填项",trigger:"blur"}],taskCommand:[{required:!0,message:"任务指令为必填项",trigger:"blur"}],cronExpression:[{required:!0,message:"cron表达式为必填项",trigger:"blur"}]}),xe=ue({__name:"form",props:{formInline:{default:()=>({title:"新增",id_code:void 0,task_code:void 0,name:"",interval:"",taskCommand:"",cronExpression:""})}},setup(n,{expose:o}){const _=n,y=i(),t=i(_.formInline);function b(){return y.value}const x=i(),{fileOptions:k,taskTypeOptions:D}=Q(x);return o({getRef:b}),(z,u)=>{const E=v("el-option"),M=v("el-select"),p=v("el-form-item"),F=v("el-input"),I=v("el-row"),q=v("el-form");return h(),R(q,{ref_key:"ruleFormRef",ref:y,model:t.value,rules:g(ye),"label-width":"82px"},{default:r(()=>[s(I,{gutter:30},{default:r(()=>[s(g($),{value:24,xs:24,sm:24},{default:r(()=>[s(p,{label:"任务类型"},{default:r(()=>[s(M,{modelValue:t.value.id_code,"onUpdate:modelValue":u[0]||(u[0]=l=>t.value.id_code=l),placeholder:"请选择任务类型",class:"w-full",clearable:""},{default:r(()=>[(h(!0),A(N,null,G(g(D),(l,C)=>(h(),R(E,{key:C,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),s(g($),{value:24,xs:24,sm:24},{default:r(()=>[s(p,{label:"任务名称",prop:"name"},{default:r(()=>[s(F,{modelValue:t.value.name,"onUpdate:modelValue":u[1]||(u[1]=l=>t.value.name=l),clearable:"",placeholder:"请输入任务名称"},null,8,["modelValue"])]),_:1})]),_:1}),s(g($),{value:24,xs:24,sm:24},{default:r(()=>[s(p,{label:"任务标识",prop:"task_code"},{default:r(()=>[s(F,{modelValue:t.value.task_code,"onUpdate:modelValue":u[2]||(u[2]=l=>t.value.task_code=l),clearable:"",placeholder:"请输入任务标识"},null,8,["modelValue"])]),_:1})]),_:1}),s(g($),{value:24,xs:24,sm:24},{default:r(()=>[t.value.id_code==5?(h(),R(p,{key:0,label:"任务文件",prop:"taskCommand"},{default:r(()=>[s(M,{modelValue:t.value.taskCommand,"onUpdate:modelValue":u[3]||(u[3]=l=>t.value.taskCommand=l),placeholder:"请选择任务文件",class:"w-full",clearable:""},{default:r(()=>[(h(!0),A(N,null,G(g(k),(l,C)=>(h(),R(E,{key:C,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):J("",!0)]),_:1}),s(g($),{value:24,xs:24,sm:24},{default:r(()=>[t.value.id_code==5?(h(),R(p,{key:0,label:"cron",prop:"cronExpression"},{default:r(()=>[s(de,{modelValue:t.value.cronExpression,"onUpdate:modelValue":u[4]||(u[4]=l=>t.value.cronExpression=l),placeholder:"请输入Cron定时规则",clearable:""},null,8,["modelValue"])]),_:1})):J("",!0)]),_:1})]),_:1})]),_:1},8,["model","rules"])}}});export{xe as _,Me as h,Q as u};
