import{ay as l,k as i,W as k,ar as g}from"./index-6f723797.js";import{b as M}from"./xdteam-1bd5232c.js";import{j as S}from"./monitor-98a23e5d.js";const e={receiveMessage:null,websocket:null,open_callback:null,close_callback:null,connectURL:"",socket_open:!1,heart_beat_timer:null,heart_beat_interval:45e3,is_reconnect:!0,reconnect_count:3,reconnect_current:1,reconnect_number:0,reconnect_timer:null,reconnect_interval:5e3,init:async(t,s,n,a)=>{if(e.connectURL=t,e.receiveMessage=s,e.close_callback=n,e.open_callback=a,!("WebSocket"in window))return l("浏览器不支持WebSocket",{type:"error"}),null;if(e.socket_open)return l("请勿重复连接",{type:"warning"}),e.websocket;const c=t;e.websocket=new WebSocket(c),e.websocket.onmessage=o=>{s&&s(o)},e.websocket.onclose=o=>{n&&n(o),clearInterval(e.heart_beat_interval),e.socket_open=!1,e.is_reconnect&&(e.reconnect_timer=setTimeout(()=>{if(e.reconnect_current>e.reconnect_count){clearTimeout(e.reconnect_timer),e.is_reconnect=!1;return}e.reconnect_current++,e.reconnect()},e.reconnect_interval))},e.websocket.onopen=function(){e.socket_open=!0,e.is_reconnect=!0,a&&a(e)},e.websocket.onerror=function(){l("socket connect failed",{type:"error"}),e.socket_open=!1}},send:(t,s=null)=>{e.websocket.readyState===e.websocket.OPEN?(e.websocket.send(JSON.stringify(t)),s&&s()):(clearInterval(e.heart_beat_timer),e.reconnect_number<1&&l("WebSocket 连接中，请耐心等待",{type:"warning"}),e.reconnect_number++)},receive:t=>JSON.parse(t.data).data,heartbeat:()=>{e.heart_beat_timer&&clearInterval(e.heart_beat_timer),e.heart_beat_timer=setInterval(()=>{const t={authToken:"token",content:"ping"};e.send(JSON.stringify(t))},e.heart_beat_interval)},close:()=>{clearInterval(e.heart_beat_interval),e.is_reconnect=!1,e.socket_open=!1,e.websocket&&e.websocket.close()},reconnect:()=>{e.websocket&&!e.is_reconnect&&e.close(),e.init(e.connectURL,e.receiveMessage,e.close_callback,e.open_callback)}},u=i({}),D=i([]),m=i(""),w=i(e.socket_open),_=i([{mineMsg:!1,nickName:"小管家",headUrl:"",time:new Date().toLocaleString(),messages:[{type:"text",content:`你好，我是小艾格，现在时间是${new Date().toLocaleString()}`}]}]),r=i({ws_url:"ws://127.0.0.1:31400/onebot/v11/ws",nickname:"木木",message_type:"group",sex:"male",age:18,user_id:"654321",group_id:"123456",card:"我才不是小呆瓜",level:"16",role:"member",bubble1:"#a3c3f6",bubble2:"#fff"}),U=async t=>{await e.init(t,L,null,async()=>{w.value=!0,l("连接建立成功",{type:"success"});try{const s=await S(),{data:n}=s;n.map(a=>{h(a)})}catch(s){console.error("获取日志列表时发生错误:",s)}})};function C(){e.close(),w.value=!1,l("连接已断开",{type:"warning"})}function h(t){var p,f,d,v;const s=t.event_name,n=t.bot_id;let a="",c="",o="";switch(s){case"message":c="info",a=(p=t.message)==null?void 0:p.message_type,o=t.message.raw_message;break;case"send_msg":c="success",a=(f=t.message)==null?void 0:f.message_type,o=O(t.message.message);break;case"notice":c="warning",a=(d=t.message)==null?void 0:d.notice_type,o="";break;case"request":c="debug",a=(v=t.message)==null?void 0:v.request_type,o="";break;default:c="info",a="info"}const x={level:c,bot:n,time:g(t.time).format("MM-DD HH:mm:ss"),name:s,type:a,data:t.message,message:o.length>50?`${o.slice(0,47)}...`:o};D.value.push(x)}const L=t=>{const s=JSON.parse(t.data),n=s.action;if(n=="send_msg"){const a=s.params.message,c={mineMsg:!1,nickName:"小管家",headUrl:"",time:new Date().toLocaleTimeString("en-US",{hour12:!1}),messages:N(a)};_.value.push(c),k().setItem("wsChatData",_.value)}else n=="make_log"&&h(s.params)};function T(){const t=m.value.trim();if(t){const s={mineMsg:!0,headUrl:"http://q.qlogo.cn/headimg_dl?dst_uin=651380741&spec=640&img_type=jpg",nickName:"我",time:new Date().toLocaleString(),content:m.value};if(r.value.message_type=="private"||r.value.message_type=="group")u.value=r.value.message_type=="group"?y(t):b(t);else if(M(t)){const n=JSON.parse(t);u.value=n}else u.value=r.value.message_type=="group"?y(t):b(t);_.value.push(s),m.value="",e.send(u.value),k().setItem("wsChatData",_.value)}else l("发送内容不能为空",{type:"warning"})}function N(t){return t.map(s=>s.type==="text"?{type:"text",content:s.data.text}:s.type==="image"||s.type==="video"?{type:s.type,content:s.data.file}:s.type==="markdown"?{type:s.type,content:JSON.parse(s.data.content).content}:{type:"text",content:s.data.text}).filter(s=>s!==null)}function O(t){return t.map(a=>a.type==="text"?a.data.text:a.type==="image"?"【图片消息】":a.type==="video"?"【视频消息】":"【事件消息】").join("")}function y(t){const s=Math.floor(g().valueOf()/1e3),n=Math.floor(Math.random()*9e8)+1e9;return{time:s,self_id:10001,post_type:"message",sub_type:"normal",user_id:r.value.user_id,message_type:"group",message_id:n,message:[{type:"text",data:{text:t}}],original_message:[{type:"text",data:{text:t}}],raw_message:t,font:0,sender:{user_id:r.value.user_id,nickname:r.value.nickname,sex:r.value.sex,age:r.value.age,card:r.value.card,area:null,level:r.value.level,role:r.value.role,title:null},to_me:!1,reply:null,group_id:r.value.group_id,anonymous:null}}function b(t){const s=Math.floor(g().valueOf()/1e3),n=Math.floor(Math.random()*9e8)+1e9;return{time:s,self_id:10001,post_type:"message",sub_type:"friend",user_id:651380741,message_type:"private",message_id:n,message:[{type:"text",data:{text:t}}],original_message:[{type:"text",data:{text:t}}],raw_message:t,font:0,sender:{user_id:r.value.user_id,nickname:r.value.nickname,sex:r.value.sex,age:null,card:null,area:null,level:null,role:null,title:null},to_me:!0,reply:null,target_id:10001}}function W(t){return t.startsWith("base64://")?`data:image/png;base64,${t.slice(9)}`:t}function q(t){return[W(t)]}export{C,r as S,T as a,U as c,W as g,m as i,D as l,_ as r,q as s,w};
